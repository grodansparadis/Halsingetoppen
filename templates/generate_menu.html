{% extends "base.html" %}

{% block title %}Generera listor - Hälsingetoppen Admin{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div class="loading-content">
        <div class="spinner-border text-primary" role="status" style="width: 4rem; height: 4rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <h4 class="mt-3" id="loadingText">Genererar lista...</h4>
        <p class="text-muted" id="loadingSubtext">Detta kan ta några sekunder</p>
        <div class="progress mt-3" style="width: 300px;">
            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" id="progressBar" style="width: 0%"></div>
        </div>
    </div>
</div>

<style>
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
}

.loading-content {
    text-align: center;
    color: white;
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.btn {
    transition: all 0.2s ease;
}

.btn:hover {
    transform: translateY(-1px);
}

.btn:disabled {
    cursor: not-allowed;
    opacity: 0.6;
}

.status-message {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000;
    min-width: 300px;
}
</style>

<div class="row">
    <div class="col-12">
        <h1><i class="fas fa-cogs me-2"></i>Generera listor och synkronisera</h1>
        <p class="text-muted">Skapa HTML-listor och synkronisera data med Spotify</p>
    </div>
</div>

<!-- Featured: Generate All Lists -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h4 class="mb-0"><i class="fas fa-rocket me-2"></i>Generera alla listor (Rekommenderat)</h4>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <p class="mb-2"><strong>Generera både topplista och låtlista i en körning</strong></p>
                        <p class="text-muted mb-3">Den mest effektiva metoden för att uppdatera alla listor samtidigt. Inkluderar valfri Spotify-uppdatering och genererar båda HTML-filerna automatiskt.</p>
                        <ul class="small text-muted mb-0">
                            <li>Automatisk generering av topplista OCH låtlista</li>
                            <li>Intelligent felhantering och återförsök</li>
                            <li>Detaljerad progress-rapportering</li>
                            <li>Optimerad för stora dataset</li>
                        </ul>
                    </div>
                    <div class="col-md-4 text-center">
                        <a href="{{ url_for('generate_all') }}" class="btn btn-warning btn-lg w-100" id="generateAllBtn"
                           onclick="showLoading('Startar batch-generering...', 'Detta kan ta 5-15 minuter beroende på inställningar')">
                            <i class="fas fa-rocket me-2"></i>Generera alla listor
                        </a>
                        <small class="text-muted d-block mt-2">
                            <i class="fas fa-clock me-1"></i>~5-15 minuter
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5><i class="fas fa-trophy me-2"></i>Generera topplista</h5>
            </div>
            <div class="card-body">
                <p>Skapa HTML-topplista med artister rankade efter popularitet.</p>
                <ul class="small">
                    <li>Sorterar efter popularitet och följare</li>
                    <li>Inkluderar artistbilder från Spotify</li>
                    <li>Uppdaterar med dagens datum</li>
                    <li>Kan uppdatera artist-data från Spotify först</li>
                </ul>
                <a href="{{ url_for('generate_toplist') }}" class="btn btn-primary w-100" id="generateToplistBtn"
                   onclick="showLoading('Genererar topplista...', 'Hämtar artistdata och skapar HTML-fil')">
                    <i class="fas fa-file-code me-1"></i>Generera topplista
                </a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-music me-2"></i>Generera låtlista</h5>
            </div>
            <div class="card-body">
                <p>Skapa HTML-lista med alla låtar i alfabetisk ordning.</p>
                <ul class="small">
                    <li>Alla artisters top tracks</li>
                    <li>Alfabetisk sortering</li>
                    <li>Länkar till Spotify</li>
                    <li>Album-typ och utgivningsdatum</li>
                </ul>
                <form method="POST" action="{{ url_for('generate_songs') }}" id="generateSongsForm">
                    <button type="submit" class="btn btn-success w-100" id="generateSongsBtn"
                            onclick="showLoading('Genererar låtlista...', 'Samlar låtdata och skapar HTML-fil')">
                        <i class="fas fa-file-code me-1"></i>Generera låtlista
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5><i class="fab fa-spotify me-2"></i>Synkronisera låtar</h5>
            </div>
            <div class="card-body">
                <p>Hämta top tracks från Spotify för alla artister.</p>
                <ul class="small">
                    <li>Hämtar top 10 tracks per artist</li>
                    <li>Uppdaterar popularitet</li>
                    <li>Ersätter all låtdata</li>
                    <li>Kan uppdatera Spotify-spellista</li>
                </ul>
                <a href="{{ url_for('sync_tracks') }}" class="btn btn-info w-100" id="syncTracksBtn"
                   onclick="showLoading('Synkroniserar låtar...', 'Detta kan ta flera minuter')">
                    <i class="fas fa-sync me-1"></i>Synkronisera låtar
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-download me-2"></i>Ladda ner genererade filer</h5>
            </div>
            <div class="card-body">
                <p>Här kan du ladda ner de senast genererade HTML-filerna:</p>
                <div class="row">
                    <div class="col-md-6">
                        {% if 'topplista' in request.args %}
                            <a href="{{ url_for('download_file', filename='topplista.html') }}" class="btn btn-outline-primary me-2">
                                <i class="fas fa-download me-1"></i>Ladda ner topplista.html
                            </a>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {% if 'songs' in request.args %}
                            <a href="{{ url_for('download_file', filename='songs.html') }}" class="btn btn-outline-success">
                                <i class="fas fa-download me-1"></i>Ladda ner songs.html
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-info">
            <h6><i class="fas fa-info-circle me-2"></i>Information</h6>
            <ul class="mb-0">
                <li><strong>Topplista</strong>: Motsvarar funktionaliteten i <code>ht.py</code></li>
                <li><strong>Låtlista</strong>: Motsvarar funktionaliteten i <code>topp_songs.py</code></li>
                <li><strong>Synkronisering</strong>: Motsvarar funktionaliteten i <code>tracks.py</code></li>
                <li>Alla operationer kräver aktiv internet-anslutning för Spotify API</li>
                <li>Synkronisering kan ta flera minuter beroende på antal artister</li>
            </ul>
        </div>
    </div>
</div>

<script>
let progressInterval;

function showLoading(title, subtitle) {
    // Show loading overlay
    document.getElementById('loadingText').textContent = title;
    document.getElementById('loadingSubtext').textContent = subtitle;
    document.getElementById('loadingOverlay').style.display = 'flex';
    
    // Disable all buttons
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.style.pointerEvents = 'none';
    });
    
    // Start progress animation
    startProgressAnimation();
    
    // Add event listener for form submission
    setTimeout(() => {
        const forms = document.querySelectorAll('form');
        forms.forEach(form => {
            form.addEventListener('submit', function() {
                updateProgress('Skickar begäran...', 20);
            });
        });
    }, 100);
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
    
    // Re-enable all buttons
    const buttons = document.querySelectorAll('.btn');
    buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.pointerEvents = 'auto';
    });
    
    // Clear progress interval
    if (progressInterval) {
        clearInterval(progressInterval);
    }
}

function startProgressAnimation() {
    let progress = 0;
    const progressBar = document.getElementById('progressBar');
    
    progressInterval = setInterval(() => {
        progress += Math.random() * 3;
        if (progress > 90) {
            progress = 90; // Don't complete until we actually finish
        }
        progressBar.style.width = progress + '%';
    }, 200);
}

function updateProgress(text, percent) {
    document.getElementById('loadingSubtext').textContent = text;
    if (percent) {
        document.getElementById('progressBar').style.width = percent + '%';
    }
}

function completeProgress() {
    document.getElementById('progressBar').style.width = '100%';
    updateProgress('Färdig!', 100);
    setTimeout(hideLoading, 1000);
}

// Handle page load with success/error messages
document.addEventListener('DOMContentLoaded', function() {
    // Check for flash messages that indicate completion
    const alerts = document.querySelectorAll('.alert');
    let hasSuccessMessage = false;
    let hasErrorMessage = false;
    
    alerts.forEach(alert => {
        if (alert.classList.contains('alert-success')) {
            hasSuccessMessage = true;
        }
        if (alert.classList.contains('alert-danger') || alert.classList.contains('alert-error')) {
            hasErrorMessage = true;
        }
    });
    
    // If we have messages, we just returned from a generation operation
    if (hasSuccessMessage || hasErrorMessage) {
        // Show a brief completion animation
        showSuccessAnimation(hasSuccessMessage);
    }
    
    // Handle form submissions with loading
    const generateSongsForm = document.getElementById('generateSongsForm');
    if (generateSongsForm) {
        generateSongsForm.addEventListener('submit', function(e) {
            showLoading('Genererar låtlista...', 'Samlar låtdata och skapar HTML-fil');
        });
    }
});

function showSuccessAnimation(isSuccess) {
    const overlay = document.createElement('div');
    overlay.className = 'loading-overlay';
    overlay.innerHTML = `
        <div class="loading-content">
            <i class="fas ${isSuccess ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning'}" 
               style="font-size: 4rem;"></i>
            <h4 class="mt-3">${isSuccess ? 'Generering klar!' : 'Ett fel uppstod'}</h4>
            <p class="text-muted">${isSuccess ? 'HTML-filen har skapats framgångsrikt' : 'Kontrollera felmeddelandet ovan'}</p>
        </div>
    `;
    
    document.body.appendChild(overlay);
    
    setTimeout(() => {
        overlay.style.opacity = '0';
        overlay.style.transition = 'opacity 0.5s ease';
        setTimeout(() => {
            document.body.removeChild(overlay);
        }, 500);
    }, 2000);
}

// Auto-hide flash messages after 5 seconds
setTimeout(() => {
    const alerts = document.querySelectorAll('.alert-dismissible');
    alerts.forEach(alert => {
        const closeBtn = alert.querySelector('.btn-close');
        if (closeBtn) {
            closeBtn.click();
        }
    });
}, 5000);
</script>
{% endblock %}